# 要件定義書

## 1. プロジェクト概要

### 1.1 背景
FFmpegは動画・音声・画像処理における最も強力なCLIツールだが、コマンドの構文が複雑で初心者にはハードルが高い。GUIでオプションを選択するだけで正しいFFmpegコマンドを生成できるWebアプリがあれば、幅広いユーザーが恩恵を受けられる。

### 1.2 目的
- FFmpegコマンドをGUIで簡単に生成できるWebアプリを提供する
- プリセット（よくある変換パターン）とカスタムフォーム（詳細設定）のハイブリッド型で、初心者から上級者まで対応する
- 生成されたコマンドをコピーして、ユーザーのローカル環境で実行できるようにする

### 1.3 対象ユーザー
- **初心者**: FFmpegを使いたいがコマンドがわからないユーザー → プリセットモードを利用
- **中級者**: 基本は理解しているが効率化したいユーザー → プリセットをカスタマイズして利用
- **上級者**: 細かいパラメータを自分で制御したいユーザー → アドバンスドモードを利用

---

## 2. 機能要件

### 2.1 プリセットモード
よくある変換パターンをカード形式で表示し、ワンクリックで選択できる。

| ID | プリセット名 | 説明 |
|----|-------------|------|
| 1 | 動画フォーマット変換 | MP4↔WebM↔MOV↔AVI間の変換 |
| 2 | 動画圧縮 | ファイルサイズ削減（CRF/ビットレート指定） |
| 3 | 音声抽出 | 動画から音声のみを抽出（MP3/AAC/WAV/FLAC） |
| 4 | 音声変換 | 音声フォーマット間の変換 |
| 5 | 動画トリム | 開始/終了時刻を指定して切り出し |
| 6 | GIF生成 | 動画からアニメーションGIFを生成（パレット付き高品質） |
| 7 | 画像変換・リサイズ | 画像のフォーマット変換、リサイズ、品質調整 |

各プリセットは以下を含む:
- デフォルトパラメータ
- ユーザーが編集可能なフィールドの定義
- 説明テキスト

### 2.2 アドバンスドモード
全パラメータを自由に設定できるフォーム。

- **入力設定**: ファイル名（拡張子指定）
- **出力設定**: ファイル名、フォーマット
- **映像設定**: コーデック、解像度、フレームレート、ビットレート、CRF
- **音声設定**: コーデック、サンプルレート、チャンネル数、ビットレート
- **フィルタ設定**: スケール、クロップ、回転
- **その他**: メタデータ削除、開始/終了時刻

### 2.3 ドラッグ＆ドロップ対応
- ファイル・フォルダの両方をD&D受付
- `webkitGetAsEntry()` APIでフォルダ内を再帰的に読み取り
- 1ファイル → 個別モード、複数/フォルダ → 一括処理モードに自動切替
- クリックによるファイル選択ダイアログも利用可能
- ドロップされたファイル名を入力フィールドに自動反映

### 2.4 一括処理（バッチモード）
- フォルダ内の全対象ファイルを一括変換するスクリプトを生成
- 3プラットフォーム対応: Bash (macOS/Linux), PowerShell (Windows), cmd (Windows Batch)
- タブ切り替えでスクリプト表示を切替
- D&Dされたファイルの拡張子から入力フィルタを自動推定

### 2.5 コマンド実行方法ガイド
- モーダルダイアログで実行手順を表示
- OS別のターミナル起動方法（macOS/Windows/Linux）
- ブラウザのセキュリティ制約（フルパス非取得）の説明
- ファイルのあるディレクトリでの実行を促すガイド

### 2.6 コマンド出力
- 生成されたFFmpegコマンドをリアルタイムで表示
- ワンクリックでクリップボードにコピー
- 一括処理時はBash/PowerShell/cmdのタブ切り替え表示

### 2.7 ダークモード
- ライト/ダークの切替トグル
- OSの設定に応じた初期テーマ
- ユーザーの選択をローカルストレージに保存

### 2.5 多言語対応（i18n）
- 日本語・英語の切替
- ブラウザの言語設定に応じた初期言語
- ユーザーの選択をローカルストレージに保存

---

## 3. 非機能要件

### 3.1 レスポンシブデザイン
- デスクトップ、タブレット、モバイルに対応
- モバイルでも快適に操作できるUI

### 3.2 パフォーマンス
- 初回ロード: 3秒以内
- コマンド生成: リアルタイム（入力変更時に即座に反映）
- Lighthouse Performance スコア 90以上を目標

### 3.3 ブラウザ対応
- Chrome, Firefox, Safari, Edge の最新2バージョン

### 3.4 アクセシビリティ
- キーボード操作対応
- 適切なARIAラベル
- 十分なコントラスト比

---

## 4. 対応FFmpeg操作一覧

### 4.1 画像圧縮（AVIF）— MVP優先
- エンコーダ: libaom-av1（静止画に最適）
- 推奨コマンド: `ffmpeg -i input.jpg -c:v libaom-av1 -still-picture 1 -crf 30 -b:v 0 -pix_fmt yuv420p10le -aom-params tune=iq output.avif`
- 主要パラメータ:
  - `-still-picture 1`: 静止画最適化（AVIF必須）
  - `-crf 0-63`: 品質（30がバランス）
  - `-pix_fmt yuv420p10le`: 10bit（8bitソースでも圧縮効率向上）
  - `-aom-params tune=iq`: 静止画向けチューニング（2025年最新）
- 対応入力: JPG, JPEG, PNG, WebP, BMP, TIFF
- 対応出力: AVIF, WebP, PNG

### 4.2 動画圧縮（AV1）— MVP優先
- エンコーダ: SVT-AV1（libsvtav1 — libaomより大幅に高速で実用的）
- 推奨コマンド: `ffmpeg -i input.mp4 -c:v libsvtav1 -crf 30 -preset 6 -pix_fmt yuv420p10le -svtav1-params tune=0:enable-overlays=1:scd=1 -c:a libopus -b:a 128k output.mkv`
- 主要パラメータ:
  - `-crf 1-63`: 品質（30がバランス）≒ x264 CRF 16相当
  - `-preset 0-13`: 速度（6がバランス、0=最遅/高品質、13=最速）
  - `-pix_fmt yuv420p10le`: 10bit
  - `tune=0`: 知覚品質優先
  - `-c:a libopus`: AV1とのベストペア音声コーデック

### 4.3 フォーマット変換
- 対応フォーマット: MP4, WebM, MOV, AVI, MKV, FLV
- コーデック指定: H.264, H.265/HEVC, VP8, VP9, AV1 (libaom-av1, libsvtav1)

### 4.4 音声操作
- 音声抽出: 動画 → MP3/AAC/WAV/FLAC/OGG
- 音声変換: フォーマット間変換
- 音声コーデック: AAC, MP3, Opus, Vorbis, FLAC, PCM

### 4.5 トリム（切り出し）
- 開始時刻 + 終了時刻指定
- 開始時刻 + 持続時間指定
- コピーモード（再エンコードなし）対応

### 4.6 GIF生成
- 基本GIF変換
- パレット生成 + 2パス変換（高品質）
- FPS、解像度指定

### 4.7 画像フォーマット変換
- フォーマット変換: PNG, JPEG, WebP, AVIF, TIFF, BMP
- リサイズ: 幅/高さ指定、アスペクト比維持
- 品質設定

---

## 5. 技術スタック

| カテゴリ | 技術 |
|---------|------|
| フレームワーク | SvelteKit + TypeScript |
| スタイリング | Tailwind CSS v4 |
| UIコンポーネント | shadcn-svelte |
| 国際化 | sveltekit-i18n |
| テスト | Vitest |
| デプロイ | Vercel |

---

## 6. 将来拡張

- **FFmpeg.wasm**: ブラウザ内でFFmpegを実行し、実際の変換処理を可能にする
- **バックエンド追加**: ファイルアップロード・処理・ダウンロード機能
- **コマンド履歴**: 過去に生成したコマンドの保存・再利用
- **共有機能**: 生成したコマンドをURLで共有
- **プリセット追加**: ユーザーからのリクエストに応じてプリセットを拡充
